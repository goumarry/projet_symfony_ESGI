{% extends 'base.html.twig' %}

{% block title %}Catalogue - NetBook{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block body %}
    <style>
        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #1f1f1f;
        }
        .book-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5) !important;
            border-color: #E50914 !important;
            z-index: 10;
        }
        .text-netbook {
            color: #E50914;
        }
    </style>

    <div class="container mt-5">
        <div class="d-flex align-items-center mb-5 border-bottom border-secondary pb-3">
            <h1 class="fw-bold text-white mb-0">Catalogue de books</h1>
            <span class="ms-auto text-muted small"><i class="bi bi-shield-lock"></i> Accès Membre</span>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-netbook" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-secondary">Chargement de la bibliothèque...</p>
        </div>

        <div id="books-grid" class="row g-4"></div>
    </div>

    <script>
        $(document).ready(function() {
            $.ajax({
                url: '/api/books',
                method: 'GET',
                dataType: 'json',
                success: function(books) {
                    $('#loading').hide();

                    if (books.length === 0) {
                        $('#books-grid').html('<div class="col-12 text-center text-muted">Aucun livre disponible pour le moment.</div>');
                        return;
                    }

                    books.forEach(function(book) {
                        let desc = book.description ? book.description : 'Aucune description disponible.';
                        if (desc.length > 100) desc = desc.substring(0, 100) + '...';

                        const cardHtml = `
                    <div class="col-md-6 col-lg-4 col-xl-3">
                        <div class="card h-100 book-card border-secondary text-white shadow-sm">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title fw-bold text-white mb-0">${book.titre}</h5>
                                </div>

                                <h6 class="card-subtitle mb-3 text-netbook fw-bold small text-uppercase">
                                    ${book.auteur}
                                </h6>

                                <p class="card-text text-secondary small flex-grow-1">
                                    ${desc}
                                </p>

                                <div class="mt-3 pt-3 border-top border-secondary d-flex justify-content-between align-items-center">
                                    <span class="badge border border-secondary text-secondary font-monospace" title="ISBN">
                                        <i class="bi bi-upc-scan"></i> ${book.isbn}
                                    </span>
                                    <small class="text-muted" style="font-size: 0.75rem;">
                                        ${book.datePublication}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                        $(cardHtml).hide().appendTo('#books-grid').fadeIn(500);
                    });
                },
                error: function(xhr, status, error) {
                    $('#loading').html(`
                        <div class="alert alert-dark border-danger text-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Erreur lors du chargement des livres.
                        </div>
                    `);
                    console.error("Erreur AJAX:", error);

                    if (xhr.status === 401 || xhr.status === 403) {
                        window.location.href = '/login';
                    }
                }
            });
        });
    </script>
{% endblock %}